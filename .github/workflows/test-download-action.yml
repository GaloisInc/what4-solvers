name: Test Download Action

on:
  push:
    branches: [main]
    paths:
      - 'action.yml'
      - 'scripts/download-solvers.sh'
      - '.github/workflows/test-download-action.yml'
  pull_request:
    paths:
      - 'action.yml'
      - 'scripts/download-solvers.sh'
      - '.github/workflows/test-download-action.yml'
  workflow_dispatch:

defaults:
  run:
    shell: bash

jobs:
  # Test all supported OS/architecture combinations
  test-matrix:
    strategy:
      fail-fast: false
      matrix:
        include:
          # Ubuntu 24.04
          - os: ubuntu-24.04
            arch: X64
            runner: ubuntu-24.04
          - os: ubuntu-24.04
            arch: ARM64
            runner: ubuntu-24.04-arm
          # Ubuntu 22.04
          - os: ubuntu-22.04
            arch: X64
            runner: ubuntu-22.04
          - os: ubuntu-22.04
            arch: ARM64
            runner: ubuntu-22.04-arm
          # macOS
          - os: macos-15
            arch: ARM64
            runner: macos-15
          - os: macos-15
            arch: X64
            runner: macos-15-intel
          # Windows
          - os: windows-2022
            arch: X64
            runner: windows-2022
    runs-on: ${{ matrix.runner }}
    steps:
      - uses: actions/checkout@v6
        with:
          persist-credentials: false

      - name: Setup what4-solvers
        uses: ./
        id: solvers

      - name: Verify solvers are on PATH
        run: |
          echo "Testing: ${{ matrix.os }} / ${{ matrix.arch }}"
          echo "Solvers path: ${STEPS_SOLVERS_OUTPUTS_SOLVERS_PATH}"

          # Check that binaries exist and are executable
          z3 --version
          yices-smt2 --version
          cvc5 --version
          boolector --version
          bitwuzla --version
        env:
          STEPS_SOLVERS_OUTPUTS_SOLVERS_PATH: ${{ steps.solvers.outputs.solvers-path }}

      - name: Test Z3 with SMT2 problem
        run: |
          cat  << EOF > /tmp/test.smt2
          (set-logic QF_LIA)
          (declare-fun x () Int)
          (assert (= x 42))
          (check-sat)
          (get-model)
          EOF
          z3 /tmp/test.smt2

  # Test RedHat UBI9 in containers
  test-ubi9:
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: X64
            runner: ubuntu-24.04
          - arch: ARM64
            runner: ubuntu-24.04-arm
    runs-on: ${{ matrix.runner }}
    container:
      image: redhat/ubi9:latest
    steps:
      - name: Install dependencies
        run: dnf install -y git unzip

      - uses: actions/checkout@v6
        with:
          persist-credentials: false

      - name: Setup what4-solvers
        uses: ./
        id: solvers

      - name: Verify solvers
        run: |
          echo "Testing: redhat-ubi9 / ${{ matrix.arch }}"
          z3 --version
          yices-smt2 --version
          cvc5 --version
          boolector --version
          bitwuzla --version

      - name: Test Z3 with SMT2 problem
        run: |
          cat  << EOF > /tmp/test.smt2
          (set-logic QF_LIA)
          (declare-fun x () Int)
          (assert (= x 42))
          (check-sat)
          (get-model)
          EOF
          z3 /tmp/test.smt2

  # Test custom destination option
  test-custom-dest:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          persist-credentials: false

      - name: Setup what4-solvers with custom destination
        uses: ./
        with:
          dest: ${{ github.workspace }}/my-solvers

      - name: Verify custom destination
        run: |
          ls -la ${{ github.workspace }}/my-solvers
          ${{ github.workspace }}/my-solvers/z3 --version

  # Test specific release tag
  test-release-tag:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v6
        with:
          persist-credentials: false

      - name: Setup what4-solvers with specific release
        uses: ./
        with:
          release: snapshot-20251112

      - name: Verify solvers
        run: z3 --version
